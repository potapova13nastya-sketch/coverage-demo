name: CI Pipeline with Coverage

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Полная история для SonarCloud
        
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: mvn clean compile -B
      
    - name: Run tests with JaCoCo
      run: mvn test jacoco:report -B
      
    - name: Upload JaCoCo report
      uses: actions/upload-artifact@v3
      with:
        name: jacoco-report
        path: target/site/jacoco/
        retention-days: 7
        
    - name: SonarCloud Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        mvn sonar:sonar \
          -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
          -Dsonar.projectKey=${{ secrets.SONAR_ORGANIZATION }}_coverage-demo \
          -Dsonar.host.url=https://sonarcloud.io \
          -B
          
    - name: Check coverage threshold
      run: mvn jacoco:check -B
      
    - name: Generate coverage badge (optional)
      run: |
        # Извлекаем процент покрытия из отчета JaCoCo
        COVERAGE=$(grep -oP 'percentage="\K[^"]+' target/site/jacoco/jacoco.xml | head -1)
        echo "Coverage percentage: $COVERAGE%"
        # Можно создать badge через shields.io
        echo "## Coverage: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
        
  incremental-coverage-check:
    name: Incremental Coverage Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v35
      with:
        since_last_remote_commit: false
        
    - name: Show changed files
      run: |
        echo "Changed files:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        
    - name: Run tests for changed files
      run: |
        # Если изменились Java файлы, запускаем все тесты
        if [ -n "${{ steps.changed-files.outputs.only_changed }}" ]; then
          echo "Running all tests due to changes in source code"
          mvn test jacoco:report -B
        else
          echo "No source code changes, skipping tests"
        fi
